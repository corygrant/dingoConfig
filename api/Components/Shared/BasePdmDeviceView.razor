@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@using application.Services
@using api.Components.Functions
@using api.Services
@inject DeviceManager DeviceManager
@inject NotificationService Notification
@typeparam TDevice where TDevice : PdmDevice

<MudContainer MaxWidth="MaxWidth.False" Style="display: flex; flex-direction: column; height: calc(100vh - 100px); width: 100%; padding: 0;">
    @* Device Control Buttons *@
    <div class="pa-3">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Download"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnReadDeviceAsync">
                Read
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Upload"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnWriteDeviceAsync">
                Write
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Save"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnBurnSettingsAsync">
                Burn
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Info"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnRequestVersionAsync">
                Version
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Bedtime"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnSleepAsync">
                Sleep
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.WbSunny"
                       Disabled="@(Device.Connected || !AdapterConnected)"
                       OnClick="@OnWakeupAsync">
                Wakeup
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.DeveloperMode"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnEnterBootloaderAsync">
                Bootloader
            </MudButton>
            <MudSpacer/>
            <MudChip T="string" Variant="Variant.Outlined" 
                     Color="@(Device.Connected ? Color.Success : Color.Error)" Size="Size.Small"
                     >
                @(Device.Connected ? "Connected" : "Disconnected")
            </MudChip>
        </MudStack>
        <MudDivider Class="my-2" />
    </div>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true">
        <MudTabPanel Text="Status" Icon="@Icons.Material.Filled.ViewList">
            <div style="overflow-y: auto; height: calc(100vh - 250px); padding: 24px; scrollbar-width: auto; scrollbar-color: #888 transparent;">
            <MudGrid>
                    <MudItem xs="12" md="3">
                        <MudText Typo="Typo.h6">@Device.BatteryVoltage.ToString("F1") V</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Battery Voltage</MudText>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudText Typo="Typo.h6">@Device.TotalCurrent.ToString("F1") A</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Current</MudText>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudText Typo="Typo.h6">@Device.BoardTempC.ToString("F1") Â°C</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Board Temperature</MudText>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudText Typo="Typo.h6">@Device.DeviceState</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Device State</MudText>
                    </MudItem>
                </MudGrid>
                
                <MudDivider Class="my-4"/>

                @* Outputs *@
                <MudText Typo="Typo.h6" Class="mb-2">Outputs</MudText>
                <MudGrid>
                    @foreach (var (output, _) in Device.GetOutputs().Select((o, i) => (o, i)))
                    {
                        <MudItem xs="6" md="3">
                            <MudCard Outlined="true" Class="pa-2">
                                <MudCardContent Class="pa-2">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body1">@output.Name</MudText>
                                        <MudChip T="string" Variant="Variant.Outlined" Color="@GetOutputColor(output.State)" Size="Size.Small">
                                            @GetOutputStateText(output.State)
                                        </MudChip>
                                        <MudText Typo="Typo.body2">@output.Current.ToString("F1") A</MudText>
                                    </MudStack>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>

                @* Digital Inputs *@
                @if (Device.GetInputs().Any())
                {
                    <MudDivider Class="my-4"/>
                    <MudText Typo="Typo.h6" Class="mb-2">Digital Inputs</MudText>
                    <MudStack Row="true" Spacing="2">
                        @foreach (var (input, index) in Device.GetInputs().Select((i, idx) => (i, idx)))
                        {
                            <MudChip T="string" Variant="Variant.Outlined" Color="@(input.State ? Color.Success : Color.Default)" Size="Size.Small">
                                Input @(index + 1): @(input.State ? "ON" : "OFF")
                            </MudChip>
                        }
                    </MudStack>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Configuration" Icon="@Icons.Material.Filled.Settings">
            <div style="overflow-y: auto; height: calc(100vh - 250px); padding: 24px; scrollbar-width: auto; scrollbar-color: #888 transparent;">
                <MudExpansionPanels MultiExpansion="true">
                    @* Inputs *@
                    @if (Device.Inputs.Any())
                    {
                        <MudExpansionPanel Text="@($"Inputs ({Device.Inputs.Count})")"
                                           ExpandedChanged="@((bool expanded) => _inputsExpanded = expanded)">
                            @if (_inputsExpanded)
                            {
                                <InputsGrid Inputs="Device.Inputs"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Outputs *@
                    @if (Device.Outputs.Any())
                    {
                        <MudExpansionPanel Text="@($"Outputs ({Device.Outputs.Count})")"
                                           ExpandedChanged="@((bool expanded) => _outputsExpanded = expanded)">
                            @if (_outputsExpanded)
                            {
                                <OutputsGrid Outputs="Device.Outputs"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Outputs PWM *@
                    @if (Device.Outputs.Any())
                    {
                        <MudExpansionPanel Text="@($"Outputs PWM ({Device.Outputs.Count})")"
                                           ExpandedChanged="@((bool expanded) => _outputsPwmExpanded = expanded)">
                            @if (_outputsPwmExpanded)
                            {
                                <OutputsPwmGrid Outputs="Device.Outputs"/>
                            }
                        </MudExpansionPanel>
                    }
                    @* CAN Inputs *@
                    @if (Device.CanInputs.Any())
                    {
                        <MudExpansionPanel Text="@($"CAN Inputs ({Device.CanInputs.Count})")"
                                           ExpandedChanged="@((bool expanded) => _canInputsExpanded = expanded)">
                            @if (_canInputsExpanded)
                            {
                                <CanInputsGrid CanInputs="Device.CanInputs"/>
                                @*
                                <MudGrid>
                                    @foreach (var canInput in Device.GetCanInputs())
                                    {
                                        <MudItem md="2">
                                            <CanInputCard Item="canInput"
                                                          DeviceId="@Device.Guid"/>
                                        </MudItem>
                                    }
                                </MudGrid>
                                *@
                            }
                        </MudExpansionPanel>
                    }

                    @* Virtual Inputs *@
                    @if (Device.VirtualInputs.Any())
                    {
                        <MudExpansionPanel Text="@($"Virtual Inputs ({Device.VirtualInputs.Count})")"
                                           ExpandedChanged="@((bool expanded) => _virtualInputsExpanded = expanded)">
                            @if (_virtualInputsExpanded)
                            {
                                <VirtualInputsGrid VirtualInputs="Device.VirtualInputs"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Conditions *@
                    @if (Device.Conditions.Any())
                    {
                        <MudExpansionPanel Text="@($"Conditions ({Device.Conditions.Count})")"
                                           ExpandedChanged="@((bool expanded) => _conditionsExpanded = expanded)">
                            @if (_conditionsExpanded)
                            {
                                <ConditionsGrid Conditions="Device.Conditions"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Counters *@
                    @if (Device.Counters.Any())
                    {
                        <MudExpansionPanel Text="@($"Counters ({Device.Counters.Count})")"
                                           ExpandedChanged="@((bool expanded) => _countersExpanded = expanded)">
                            @if (_countersExpanded)
                            {
                                <CountersGrid Counters="Device.Counters"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Flashers *@
                    @if (Device.Flashers.Any())
                    {
                        <MudExpansionPanel Text="@($"Flashers ({Device.Flashers.Count})")"
                                           ExpandedChanged="@((bool expanded) => _flashersExpanded = expanded)">
                            @if (_flashersExpanded)
                            {
                                <FlashersGrid Flashers="Device.Flashers"/>
                            }
                        </MudExpansionPanel>
                    }

                    @* Wiper *@
                    <MudExpansionPanel Text="Wiper"
                                       ExpandedChanged="@((bool expanded) => _wiperExpanded = expanded)">
                        @if (_wiperExpanded)
                        {
                            <WiperConfig Wiper="Device.Wipers"/>
                        }
                    </MudExpansionPanel>

                    @* Starter Disable *@
                    <MudExpansionPanel Text="Starter Disable"
                                       ExpandedChanged="@((bool expanded) => _starterDisableExpanded = expanded)">
                        @if (_starterDisableExpanded)
                        {
                            <StarterDisableConfig StarterDisable="Device.StarterDisable"/>
                        }
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </div>
        </MudTabPanel>
        <MudTabPanel Text="Plot" Icon="@Icons.Material.Filled.StackedLineChart">
            <MudIcon Size="Size.Large" Icon="@Icons.Custom.Uncategorized.Radioactive"/>
            <MudText Typo="Typo.h5">Under construction</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Flow" Icon="@Icons.Material.Filled.DataExploration">
            <MudIcon Size="Size.Large" Icon="@Icons.Custom.Uncategorized.BioHazard"/>
            <MudText Typo="Typo.h5">Under construction</MudText> 
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    [Parameter, EditorRequired]
    public TDevice Device { get; set; } = null!;

    [Parameter, EditorRequired]
    public string DeviceName { get; set; } = null!;
    
    [Parameter, EditorRequired]
    public bool AdapterConnected { get; set; }

    // Expansion panel state tracking for lazy loading
    private bool _inputsExpanded;
    private bool _outputsExpanded;
    private bool _outputsPwmExpanded;
    private bool _canInputsExpanded;
    private bool _virtualInputsExpanded;
    private bool _conditionsExpanded;
    private bool _countersExpanded;
    private bool _flashersExpanded;
    private bool _wiperExpanded;
    private bool _starterDisableExpanded;

    private static Color GetOutputColor(OutState state) => state switch
    {
        OutState.On => Color.Success,
        OutState.Overcurrent => Color.Error,
        OutState.Fault => Color.Warning,
        _ => Color.Default      // Off
    };

    private static string GetOutputStateText(OutState state) => state switch
    {
        OutState.On => "ON",
        OutState.Overcurrent => "OVERCURRENT",
        OutState.Fault => "RESETTING",
        _ => "OFF"
    };

    // Device operation methods - Direct service calls (no HTTP)
    private void OnReadDeviceAsync()
    {
        try
        {
            DeviceManager.ReadDeviceConfig(Device.Guid);
            Notification.NewInfo($"Device read initiated: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error reading device: {DeviceName}", ex);
        }
    }

    private void OnWriteDeviceAsync()
    {
        try
        {
            DeviceManager.WriteDeviceConfig(Device.Guid);
            Notification.NewSuccess($"Device write initiated: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error writing device: {DeviceName}",ex);
        }
    }

    private void OnBurnSettingsAsync()
    {
        try
        {
            if (DeviceManager.BurnSettings(Device.Guid))
                Notification.NewSuccess($"Burn sent to device: {DeviceName}");
            else
                Notification.NewError($"Failed to send burn: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error sending burn: {DeviceName}", ex);
        }
    }

    private void OnRequestVersionAsync()
    {
        try
        {
            if (DeviceManager.RequestVersion(Device.Guid))
                Notification.NewSuccess($"Version request sent: {DeviceName}");
            else
                Notification.NewError($"Failed to request version: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error requesting version: {DeviceName}", ex);
        }
    }

    private void OnSleepAsync()
    {
        try
        {
            if (DeviceManager.RequestSleep(Device.Guid))
                Notification.NewSuccess($"Sleep sent: {DeviceName}");
            else
                Notification.NewError($"Failed to send sleep: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error sending sleep: {DeviceName}", ex);
        }
    }

    private void OnWakeupAsync()
    {
        try
        {
            if (DeviceManager.RequestWakeup(Device.Guid))
                Notification.NewSuccess($"Wakeup command sent: {DeviceName}");
            else
                Notification.NewError($"Failed to send wakeup: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error sending wakeup: {DeviceName}", ex);
        }
    }

    private void OnEnterBootloaderAsync()
    {
        try
        {
            if (DeviceManager.RequestBootloader(Device.Guid))
                Notification.NewSuccess($"Bootloader command sent: {DeviceName}");
            else
                Notification.NewError($"Failed to send bootloader command: {DeviceName}");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error sending bootloader command: {DeviceName}",  ex);
        }
    }
}
