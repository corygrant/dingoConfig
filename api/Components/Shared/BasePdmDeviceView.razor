@using contracts.Devices.Pdm
@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@using application.Services
@using api.Components.Functions
@inject DeviceManager DeviceManager
@typeparam TDto where TDto : PdmDto
@typeparam TDevice where TDevice : PdmDevice

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h5">@DeviceName - @State.Name</MudText>
                <MudChip T="string" Color="@(State.Connected ? Color.Success : Color.Error)" Size="Size.Small">
                    @(State.Connected ? "Connected" : "Disconnected")
                </MudChip>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudText Typo="Typo.caption">GUID: @State.Guid</MudText>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @* Device-level metrics *@
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.BatteryVoltage.ToString("F1") V</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Battery Voltage</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.TotalCurrent.ToString("F1") A</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Current</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.BoardTempC.ToString("F1") Â°C</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Board Temperature</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.State</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Device State</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        @* Outputs *@
        <MudText Typo="Typo.h6" Class="mb-2">Outputs</MudText>
        <MudGrid>
            @foreach (var (output, index) in State.Outputs.Select((o, i) => (o, i)))
            {
                <MudItem xs="6" md="3">
                    <MudCard Outlined="true" Class="pa-2">
                        <MudCardContent Class="pa-2">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1">Output @(index + 1)</MudText>
                                <MudChip T="string" Color="@GetOutputColor(output.State)" Size="Size.Small">
                                    @GetOutputStateText(output.State)
                                </MudChip>
                                <MudText Typo="Typo.body2">@output.Current.ToString("F1") A</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Digital Inputs *@
        @if (State.Inputs.Any())
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Digital Inputs</MudText>
            <MudStack Row="true" Spacing="2">
                @foreach (var (input, index) in State.Inputs.Select((i, idx) => (i, idx)))
                {
                    <MudChip T="string" Color="@(input.State ? Color.Success : Color.Default)" Size="Size.Small">
                        Input @(index + 1): @(input.State ? "ON" : "OFF")
                    </MudChip>
                }
            </MudStack>
        }

        @* Function Configurations *@
        @if (_device != null)
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h5" Class="mb-4">Configuration</MudText>

            <MudExpansionPanels MultiExpansion="true">
                @* Inputs *@
                @if (_device.Inputs.Any())
                {
                    <MudExpansionPanel Text="@($"Inputs ({_device.Inputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _inputsExpanded = expanded)">
                        @if (_inputsExpanded)
                        {
                            <InputsGrid Inputs="_device.Inputs"/>
                        }
                    </MudExpansionPanel>
                }

                @* Outputs *@
                @if (_device.Outputs.Any())
                {
                    <MudExpansionPanel Text="@($"Outputs ({_device.Outputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _outputsExpanded = expanded)">
                        @if (_outputsExpanded)
                        {
                            <OutputsGrid Outputs="_device.Outputs" />
                        }
                    </MudExpansionPanel>
                }

                @* CAN Inputs *@
                @if (_device.CanInputs.Any())
                {
                    <MudExpansionPanel Text="@($"CAN Inputs ({_device.CanInputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _canInputsExpanded = expanded)">
                        @if (_canInputsExpanded)
                        {
                            <CanInputsGrid CanInputs="_device.CanInputs" />
                        }
                    </MudExpansionPanel>
                }

                @* Virtual Inputs *@
                @if (_device.VirtualInputs.Any())
                {
                    <MudExpansionPanel Text="@($"Virtual Inputs ({_device.VirtualInputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _virtualInputsExpanded = expanded)">
                        @if (_virtualInputsExpanded)
                        {
                            <VirtualInputsGrid VirtualInputs="_device.VirtualInputs" />
                        }
                    </MudExpansionPanel>
                }

                @* Conditions *@
                @if (_device.Conditions.Any())
                {
                    <MudExpansionPanel Text="@($"Conditions ({_device.Conditions.Count})")"
                                       ExpandedChanged="@((bool expanded) => _conditionsExpanded = expanded)">
                        @if (_conditionsExpanded)
                        {
                            <ConditionsGrid Conditions="_device.Conditions" />
                        }
                    </MudExpansionPanel>
                }

                @* Counters *@
                @if (_device.Counters.Any())
                {
                    <MudExpansionPanel Text="@($"Counters ({_device.Counters.Count})")"
                                       ExpandedChanged="@((bool expanded) => _countersExpanded = expanded)">
                        @if (_countersExpanded)
                        {
                            <CountersGrid Counters="_device.Counters" />
                        }
                    </MudExpansionPanel>
                }

                @* Flashers *@
                @if (_device.Flashers.Any())
                {
                    <MudExpansionPanel Text="@($"Flashers ({_device.Flashers.Count})")"
                                       ExpandedChanged="@((bool expanded) => _flashersExpanded = expanded)">
                        @if (_flashersExpanded)
                        {
                            <FlashersGrid Flashers="_device.Flashers" />
                        }
                    </MudExpansionPanel>
                }

                @* Wiper *@
                <MudExpansionPanel Text="Wiper"
                                   ExpandedChanged="@((bool expanded) => _wiperExpanded = expanded)">
                    @if (_wiperExpanded)
                    {
                        <WiperConfig Wiper="_device.Wipers" />
                    }
                </MudExpansionPanel>

                @* Starter Disable *@
                <MudExpansionPanel Text="Starter Disable"
                                   ExpandedChanged="@((bool expanded) => _starterDisableExpanded = expanded)">
                    @if (_starterDisableExpanded)
                    {
                        <StarterDisableConfig StarterDisable="_device.StarterDisable" />
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

    </MudCardContent>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public TDto State { get; set; } = null!;

    [Parameter, EditorRequired]
    public string DeviceName { get; set; } = null!;

    private TDevice? _device;

    // Expansion panel state tracking for lazy loading
    private bool _inputsExpanded = false;
    private bool _outputsExpanded = false;
    private bool _canInputsExpanded = false;
    private bool _virtualInputsExpanded = false;
    private bool _conditionsExpanded = false;
    private bool _countersExpanded = false;
    private bool _flashersExpanded = false;
    private bool _wiperExpanded = false;
    private bool _starterDisableExpanded = false;

    protected override void OnParametersSet()
    {
        // Get the actual device from DeviceManager to access function collections
        _device = DeviceManager.GetDevice<TDevice>(State.Guid);
    }

    private static Color GetOutputColor(OutState state) => state switch
    {
        OutState.On => Color.Success,
        OutState.Overcurrent => Color.Error,
        OutState.Fault => Color.Warning,
        _ => Color.Default      // Off
    };

    private static string GetOutputStateText(OutState state) => state switch
    {
        OutState.On => "ON",
        OutState.Overcurrent => "OVERCURRENT",
        OutState.Fault => "RESETTING",
        _ => "OFF"
    };
}
